import os
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
)

# ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==================

TOKEN = os.getenv("TELEGRAM_BOT_TOKEN5644960695:AAGx5jysi7ZYFFQw14LNIlcS2bpRCXWAg6g")

CHANNELS = ["@Muslim_vip1"]   # Ù‚Ù†Ø§Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
ADMIN_ID = 5083996619         # Ø§ÙŠØ¯ÙŠ Ø§Ù„Ø£Ø¯Ù…Ù†

users = {}  # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¯Ø¹ÙˆØ§Øª

# ================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ==================

async def is_subscribed(bot, user_id):
    for channel in CHANNELS:
        try:
            member = await bot.get_chat_member(channel, user_id)
            if member.status in ["left", "kicked"]:
                return False
        except:
            return False
    return True

# ================== /start ==================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    # ØªØ­Ù‚Ù‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    if not await is_subscribed(context.bot, user_id):
        await update.message.reply_text(
            "ğŸš« Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø£ÙˆÙ„:\n"
            "@Muslim_vip1\n\n"
            "ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø¨Ø¹Øª /start"
        )
        return

    # Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª
    ref = context.args[0] if context.args else None

    if user_id not in users:
        users[user_id] = {"refs": 0}
        if ref and ref.isdigit():
            ref_id = int(ref)
            if ref_id != user_id and ref_id in users:
                users[ref_id]["refs"] += 1

    refs = users[user_id]["refs"]
    link = f"https://t.me/VersatileVIP_bot?start={user_id}"

    await update.message.reply_text(
        f"""âœ… Ø£Ù‡Ù„Ù‹Ø§ Ø¨ÙŠÙƒ!

ğŸ‘¥ Ø¹Ø¯Ø¯ Ø¯Ø¹ÙˆØ§ØªÙƒ: {refs}

ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:
{link}
"""
    )

# ================== /link ==================

async def link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    link = f"https://t.me/VersatileVIP_bot?start={user_id}"
    await update.message.reply_text(f"ğŸ”— Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ:\n{link}")

# ================== /stats (Ø£Ø¯Ù…Ù†) ==================

async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return
    await update.message.reply_text(
        f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:\n"
        f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {len(users)}"
    )

# ================== Ø§Ù„ØªØ´ØºÙŠÙ„ ==================

def main():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("link", link))
    app.add_handler(CommandHandler("stats", stats))

    print("ğŸ¤– Bot is running...")
    app.run_polling()

if __name__ == "__main__":
    main()
